<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
  </head>

  <body>
    <script id="store" type="application/json">
      {
        "count": 0
      }
    </script>

    <section>
      <h1>Default selector</h1>
      <p>
        Count: <output selectorfor="store" selector="count">0</output>
      </p>
      <div role="toolbar">
        <button commandfor="store" command="--increment" data-by="1">
          Increment by 1
        </button>
        <button commandfor="store" command="--increment" data-by="5">
          Increment by 5
        </button>
      </div>
    </section>

    <hr />

    <section>
      <h1>Attribute selector</h1>
      <input
        type="number"
        selectorfor="store"
        selector="value:count aria-valuenow:count"
        value="0"
        aria-valuenow="0"
        readonly
      />
      <!--
        Alternative API:
        <el-observer for="store" sync="value:count">
         <input type="number" value="0" />
        </el-observer>
      -->
    </section>

    <script>
      document.getElementById("store").addEventListener(
        "command",
        (event) => {
          const store = event.target;

          const currentState = JSON.parse(store.text);

          const payload = event.source.dataset;
          const action = {
            ...payload,
            type: event.command,
          };

          const nextState = reducer(currentState, action);
          store.text = JSON.stringify(nextState, null, 2);

          const listeners = Array.from(
            document.querySelectorAll(`[selectorfor="${store.id}"]`),
          );

          for (const listener of listeners) {
            const selector = listener.getAttribute("selector");
            const parts = selector.split(" ");

            for (const part of parts) {
              if (part.includes(":")) {
                const [attr, selector] = part.split(":");
                listener.setAttribute(attr, nextState[selector]);
              } else {
                listener.textContent = nextState[selector];
              }
            }
          }
        },
      );

      function reducer(state, action) {
        switch (action.type) {
          case "--increment": {
            return {
              ...state,
              count: state.count + Number(action.by),
            };
          }
          default: {
            return state;
          }
        }
      }
    </script>
  </body>
</html>
